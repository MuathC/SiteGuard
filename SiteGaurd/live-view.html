<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Drone View - SiteGuard</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="logo.png" alt="SiteGuard Logo" class="logo-image">
                <h1>SiteGuard</h1>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="live-view.html" class="active">Live View</a></li>
                <li><a href="solutions.html">Solutions</a></li>
            </ul>
        </div>
    </nav>

    <!-- Live View Container -->
    <div class="live-view-container">
        <h1 class="page-title">Live Drone Feeds</h1>

        <div class="live-view-layout">
            
            <!-- Drone Selection Panel -->
            <aside class="drone-panel">
                <h2>Active Drones</h2>
                <div class="drone-list" id="droneList">
                    
                    <div class="drone-item active" data-drone-id="1" onclick="switchDrone(1)">
                        <div class="drone-status-indicator online"></div>
                        <div class="drone-info">
                            <h3>Drone 1</h3>
                            <p class="drone-status">Patrolling Zone A</p>
                            <div class="drone-stats">
                                <span>ðŸ”‹ 85%</span>
                                <span>ðŸ“¡ Excellent</span>
                            </div>
                        </div>
                    </div>

                    <div class="drone-item" data-drone-id="2" onclick="switchDrone(2)">
                        <div class="drone-status-indicator online"></div>
                        <div class="drone-info">
                            <h3>Drone 2</h3>
                            <p class="drone-status">Monitoring Fire Alert</p>
                            <div class="drone-stats">
                                <span>ðŸ”‹ 92%</span>
                                <span>ðŸ“¡ Good</span>
                            </div>
                        </div>
                    </div>

                    <div class="drone-item" data-drone-id="3" onclick="switchDrone(3)">
                        <div class="drone-status-indicator warning"></div>
                        <div class="drone-info">
                            <h3>Drone 3</h3>
                            <p class="drone-status">Low Battery - Charging</p>
                            <div class="drone-stats">
                                <span>ðŸ”‹ 23%</span>
                                <span>ðŸ“¡ N/A</span>
                            </div>
                        </div>
                    </div>

                    <div class="drone-item" data-drone-id="4" onclick="switchDrone(4)">
                        <div class="drone-status-indicator online"></div>
                        <div class="drone-info">
                            <h3>Drone 4</h3>
                            <p class="drone-status">Perimeter Patrol</p>
                            <div class="drone-stats">
                                <span>ðŸ”‹ 78%</span>
                                <span>ðŸ“¡ Excellent</span>
                            </div>
                        </div>
                    </div>

                    <div class="drone-item" data-drone-id="5" onclick="switchDrone(5)">
                        <div class="drone-status-indicator offline"></div>
                        <div class="drone-info">
                            <h3>Drone 5</h3>
                            <p class="drone-status">Offline - Maintenance</p>
                            <div class="drone-stats">
                                <span>ðŸ”‹ 0%</span>
                                <span>ðŸ“¡ N/A</span>
                            </div>
                        </div>
                    </div>

                </div>
            </aside>

            <!-- Main Video Feed -->
            <main class="video-main">
                <div class="video-header">
                    <h2 id="currentDroneTitle">Drone 1 - Live Feed</h2>
                    <div class="video-controls">
                        <button class="btn btn-secondary" onclick="toggleFullscreen()">â›¶ Fullscreen</button>
                    </div>
                </div>

                <!-- Video Container (Gazebo-ready structure) -->
                <div class="video-container" id="videoContainer">
                    <!-- Live Object Detection Stream from Flask Server -->
                    <div class="video-feed" id="videoFeed" data-stream-source="flask-stream">
                        <!-- MJPEG Stream from Flask Server -->
                        <img src="http://localhost:5000/video_feed" 
                             id="videoElement" 
                             style="width: 100%; height: 100%; object-fit: cover;"
                             alt="Live Detection Stream"
                             onerror="handleStreamError()">
                        
                        <!-- AI Detection Overlays (detections are already drawn on the stream) -->
                        <div class="detection-overlays" id="detectionOverlays">
                            <!-- Detections are rendered on the video by YOLOv8 -->
                        </div>

                        <!-- Drone Telemetry Overlay -->
                        <div class="telemetry-overlay">
                            <div class="telemetry-item">
                                <span class="telemetry-label">Altitude:</span>
                                <span class="telemetry-value" id="altitude">50m</span>
                            </div>
                            <div class="telemetry-item">
                                <span class="telemetry-label">Speed:</span>
                                <span class="telemetry-value" id="speed">10 m/s</span>
                            </div>
                            <div class="telemetry-item">
                                <span class="telemetry-label">Battery:</span>
                                <span class="telemetry-value" id="battery">85%</span>
                            </div>
                            <div class="telemetry-item">
                                <span class="telemetry-label">GPS:</span>
                                <span class="telemetry-value" id="gps">37.7749, -122.4194</span>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Status Indicator -->
                    <div class="stream-status connected" id="streamStatus">
                        <span class="status-dot"></span>
                        <span>Live Stream Active</span>
                    </div>
                </div>

                <!-- Stream Info -->
                <div class="stream-info">
                    <p><strong>Stream Source:</strong> <span id="streamSource">Flask Server (YOLOv8 Detection)</span></p>
                    <p><strong>Resolution:</strong> <span id="streamResolution">1280x720</span></p>
                    <p><strong>FPS:</strong> <span id="streamFps">Loading...</span></p>
                    <p><strong>Status:</strong> <span id="streamStatus">Connecting...</span></p>
                </div>
            </main>

            <!-- Event Stream Sidebar -->
            <aside class="event-stream">
                <h2>Live Event Log</h2>
                <p class="event-drone-label" id="eventDroneLabel">Drone 1</p>
                <div class="event-list" id="eventList">
                    <!-- Events will be dynamically generated by JavaScript -->
                </div>
            </aside>

        </div>
    </div>

    <!-- Flask Stream Integration Script -->
    <script>
        // Flask server configuration
        const FLASK_SERVER = 'http://localhost:5000';
        
        // Handle stream errors
        function handleStreamError() {
            const statusEl = document.getElementById('streamStatus');
            const streamStatusEl = document.getElementById('streamStatus');
            if (statusEl) statusEl.textContent = 'Connection Error - Check if server is running';
            if (streamStatusEl) streamStatusEl.classList.remove('connected');
            console.error('Stream connection failed. Make sure Flask server is running on port 5000');
        }
        
        // Update FPS and status from Flask server
        async function updateStreamStatus() {
            try {
                const response = await fetch(`${FLASK_SERVER}/status`);
                const data = await response.json();
                
                if (data.status === 'running') {
                    document.getElementById('streamStatus').textContent = 'Connected âœ“';
                    document.getElementById('streamFps').textContent = data.fps[0] || 'Loading...';
                    document.getElementById('streamStatus').classList.add('connected');
                } else {
                    document.getElementById('streamStatus').textContent = 'Initializing...';
                }
            } catch (error) {
                document.getElementById('streamStatus').textContent = 'Server Offline';
                console.error('Failed to fetch stream status:', error);
            }
        }
        
        // Update status every 2 seconds
        setInterval(updateStreamStatus, 2000);
        
        // Initial status check
        setTimeout(updateStreamStatus, 1000);
        
        // Log connection attempt
        console.log('Connecting to Flask server at:', FLASK_SERVER);
        console.log('Video feed URL:', `${FLASK_SERVER}/video_feed`);
    </script>

    <script src="app.js"></script>
</body>
</html>

